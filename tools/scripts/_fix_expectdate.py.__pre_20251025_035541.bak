# tools/scripts/_fix_expectdate.py (safe)
import json, sys
from pathlib import Path
import pandas as pd

root = Path(".").resolve()
cal  = pd.read_csv(root/"cal"/"trading_days.csv")

# 1) 嚴格解析 -> 去空 -> 本地時區化（全 tz-aware）
cal["date"] = pd.to_datetime(cal["date"], format="%Y-%m-%d", errors="coerce")
cal = cal.dropna(subset=["date"])
cal["date"] = cal["date"].dt.tz_localize("Asia/Taipei", nonexistent="shift_forward", ambiguous="NaT")
cal["is_open"] = cal.get("is_open", 1).fillna(1).astype(int)

# 2) 今天（台北時區）→ 最近 <= 今天 且 is_open=1 的交易日
today = pd.Timestamp.now(tz="Asia/Taipei").normalize()
mask  = (cal["date"] <= today) & (cal["is_open"] == 1)
if not mask.any():
    sys.exit(0)
exp = cal.loc[mask, "date"].max().date().isoformat()

# 3) 覆寫 preflight_report.json 的 meta.expect_date
rp = root/"reports"/"preflight_report.json"
obj = json.loads(rp.read_text(encoding="utf-8"))
obj.setdefault("meta", {})["expect_date"] = exp
rp.write_text(json.dumps(obj, ensure_ascii=False, indent=2), encoding="utf-8")
print(f"[PATCH] expect_date -> {exp}")
